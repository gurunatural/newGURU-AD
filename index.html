<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GURU AD | Marketing Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        /* Custom scrollbar for a premium feel */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .login-bg { background-color: #f3f4f6; }
        .dark .login-bg { background-color: #111827; }
        
        /* Hide scrollbar for chrome/safari/opera */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .scrollbar-hide {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 transition-colors duration-200">
    <div id="root"></div>

    <!-- Import Map to tell the browser where to find libraries -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.344.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"
        }
    }
    </script>

    <!-- Main Application Code -->
    <script type="text/babel" data-type="module">
        import React, { useState, useMemo, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from "firebase/app";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged, 
            signInWithCustomToken 
        } from "firebase/auth";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            doc, 
            onSnapshot, 
            query, 
            orderBy 
        } from "firebase/firestore";
        import { 
            LayoutDashboard, 
            TrendingUp, 
            Share2, 
            DollarSign, 
            ShoppingBag, 
            Settings, 
            Menu, 
            X, 
            Bell, 
            Search, 
            Plus, 
            Trash2, 
            Users, 
            CreditCard, 
            Activity, 
            ExternalLink, 
            Edit2, 
            Globe, 
            Save, 
            PieChart as PieChartIcon, 
            BarChart as BarChartIcon, 
            Download,
            LogOut,
            Lock,
            Filter
        } from 'lucide-react';

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBXL7QF_w6t3G2XSnnZoq-jDA-sY62eCbA",
            authDomain: "guruad-81a86.firebaseapp.com",
            projectId: "guruad-81a86",
            storageBucket: "guruad-81a86.firebasestorage.app",
            messagingSenderId: "890101067202",
            appId: "1:890101067202:web:d286c8dedf93a6d8387a5b"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const APP_ID = "guru-marketing-v1";

        // --- COMPONENTS ---

        const LoginScreen = ({ onJoin, darkMode }) => {
            const [code, setCode] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if(code.trim().length > 0) {
                    onJoin(code.trim().toUpperCase().replace(/\s/g, '_'));
                }
            };

            return (
                <div className={`min-h-screen flex flex-col items-center justify-center p-4 login-bg ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                    <div className={`w-full max-w-md p-8 rounded-2xl shadow-xl ${darkMode ? 'bg-gray-800 border border-gray-700' : 'bg-white border border-gray-100'}`}>
                        <div className="flex justify-center mb-6">
                            <div className="w-16 h-16 bg-indigo-600 rounded-2xl flex items-center justify-center shadow-lg shadow-indigo-500/30">
                                <span className="text-3xl font-bold text-white">G</span>
                            </div>
                        </div>
                        <h2 className="text-2xl font-bold text-center mb-2">Welcome to GURU AD</h2>
                        <p className={`text-center mb-8 text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                            Enter a Dashboard Name to access your shared data. Use the same name on all devices.
                        </p>
                        
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold uppercase mb-1 ml-1 text-gray-500">Dashboard Name / Access Code</label>
                                <div className="relative">
                                    <Lock className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={18} />
                                    <input 
                                        type="text" 
                                        value={code}
                                        onChange={(e) => setCode(e.target.value)}
                                        placeholder="e.g. MARKETING_TEAM_1"
                                        className={`w-full pl-10 pr-4 py-3 rounded-xl border-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all font-bold tracking-wide ${darkMode ? 'bg-gray-900 border-gray-700 text-white focus:border-indigo-500' : 'bg-gray-50 border-gray-200 text-gray-900 focus:bg-white'}`}
                                    />
                                </div>
                            </div>
                            <button 
                                type="submit"
                                className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-indigo-500/30 transition-all active:scale-95"
                            >
                                Access Dashboard
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const SidebarItem = ({ icon: Icon, label, active, onClick }) => (
            <button
                onClick={onClick}
                className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 group ${
                active 
                    ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/30' 
                    : 'text-gray-400 hover:bg-gray-800 hover:text-white'
                }`}
            >
                <Icon size={20} className={`${active ? 'text-white' : 'text-gray-400 group-hover:text-white'}`} />
                <span className={`font-medium text-sm whitespace-nowrap ${!label && 'hidden md:hidden'}`}>{label}</span>
                {active && <div className="ml-auto w-1.5 h-1.5 rounded-full bg-white animate-pulse" />}
            </button>
        );

        const StatCard = ({ title, value, subtext, icon: Icon, color, darkMode }) => (
            <div className={`${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-100'} p-6 rounded-xl shadow-sm border hover:shadow-md transition-shadow`}>
                <div className="flex justify-between items-start">
                <div>
                    <p className={`${darkMode ? 'text-gray-400' : 'text-gray-500'} text-sm font-medium`}>{title}</p>
                    <h3 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mt-1`}>{value}</h3>
                </div>
                <div className={`p-2 rounded-lg ${color}`}>
                    <Icon size={20} className="text-white" />
                </div>
                </div>
                {subtext && (
                <div className="mt-4 flex items-center text-sm text-gray-400">
                    {subtext}
                </div>
                )}
            </div>
        );

        // --- SECTIONS ---

        const AnalysisSection = ({ ads, darkMode }) => {
            const stats = useMemo(() => {
                const total = ads.reduce((sum, ad) => sum + (parseFloat(ad.amount) || 0), 0);
                const count = ads.length;
                const avg = count > 0 ? total / count : 0;
                const max = ads.reduce((m, ad) => Math.max(m, parseFloat(ad.amount) || 0), 0);
                return { total, count, avg, max };
            }, [ads]);

            const typeData = useMemo(() => {
                const counts = {};
                ads.forEach(ad => {
                counts[ad.type] = (counts[ad.type] || 0) + (parseFloat(ad.amount) || 0);
                });
                return Object.entries(counts)
                .map(([name, value]) => ({ name, value }))
                .sort((a, b) => b.value - a.value);
            }, [ads]);

            const platformData = useMemo(() => {
                const counts = {};
                ads.forEach(ad => {
                let label = 'Other';
                if (ad.type === 'Performance') label = ad.platform;
                else if (ad.type === 'Influencer') label = ad.influencerName || 'Unknown Influencer';
                else if (ad.type === 'Print Media') label = ad.printMedium || 'Unknown Print';
                else label = ad.customDetails || ad.type;

                if(label) {
                    counts[label] = (counts[label] || 0) + (parseFloat(ad.amount) || 0);
                }
                });
                return Object.entries(counts)
                .map(([name, value]) => ({ name, value }))
                .sort((a, b) => b.value - a.value)
                .slice(0, 8);
            }, [ads]);

            const pieGradient = useMemo(() => {
                if (stats.total === 0) return `conic-gradient(#e5e7eb 0% 100%)`;
                let currentDeg = 0;
                const colors = ['#6366f1', '#ec4899', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6'];
                const segments = typeData.map((item, index) => {
                const deg = (item.value / stats.total) * 360;
                const start = currentDeg;
                currentDeg += deg;
                return `${colors[index % colors.length]} ${start}deg ${currentDeg}deg`;
                }).join(', ');
                return `conic-gradient(${segments})`;
            }, [typeData, stats.total]);

            const colors = ['bg-indigo-500', 'bg-pink-500', 'bg-amber-500', 'bg-emerald-500', 'bg-blue-500', 'bg-violet-500'];

            return (
                <div className="space-y-6">
                <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <h2 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Analysis Overview</h2>
                    <button 
                        onClick={() => window.open('https://gurusalesdashboard.netlify.app/', '_blank')}
                        className="w-full md:w-auto bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-emerald-700 transition flex items-center justify-center gap-2 shadow-sm"
                    >
                        Ad Sales Revenue <ExternalLink size={16} />
                    </button>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <StatCard darkMode={darkMode} title="Total Ad Spend" value={`₹${stats.total.toLocaleString()}`} subtext={`${stats.count} total entries`} icon={CreditCard} color="bg-rose-500" />
                    <StatCard darkMode={darkMode} title="Average Cost" value={`₹${stats.avg.toFixed(0).toLocaleString()}`} subtext="Per advertisement" icon={Activity} color="bg-blue-500" />
                    <StatCard darkMode={darkMode} title="Highest Spend" value={`₹${stats.max.toLocaleString()}`} subtext="Single campaign max" icon={TrendingUp} color="bg-indigo-500" />
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div className={`${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-100'} p-6 rounded-xl shadow-sm border`}>
                    <h3 className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-6 flex items-center gap-2`}>
                        <PieChartIcon size={20} className="text-indigo-500"/> Spend by Ad Type
                    </h3>
                    {stats.total > 0 ? (
                        <div className="flex flex-col md:flex-row items-center gap-8">
                        <div className="relative w-48 h-48 rounded-full shadow-inner flex-shrink-0 mx-auto md:mx-0" style={{ background: pieGradient }}>
                            <div className={`absolute inset-4 rounded-full ${darkMode ? 'bg-gray-800' : 'bg-white'} flex items-center justify-center shadow-sm`}>
                            <span className={`text-xs font-bold ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>DISTRIBUTION</span>
                            </div>
                        </div>
                        <div className="flex-1 w-full space-y-3">
                            {typeData.map((item, index) => (
                            <div key={item.name} className="flex items-center justify-between text-sm">
                                <div className="flex items-center gap-2">
                                <div className={`w-3 h-3 rounded-full ${colors[index % colors.length]}`}></div>
                                <span className={`${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>{item.name}</span>
                                </div>
                                <span className={`font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                                {((item.value / stats.total) * 100).toFixed(1)}% (₹{item.value.toLocaleString()})
                                </span>
                            </div>
                            ))}
                        </div>
                        </div>
                    ) : (
                        <div className="h-48 flex items-center justify-center text-gray-400">No data available</div>
                    )}
                    </div>

                    <div className={`${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-100'} p-6 rounded-xl shadow-sm border`}>
                    <h3 className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-6 flex items-center gap-2`}>
                        <BarChartIcon size={20} className="text-emerald-500"/> Top Spending Platforms
                    </h3>
                    {stats.total > 0 ? (
                        <div className="space-y-4">
                        {platformData.map((item, index) => (
                            <div key={item.name}>
                            <div className="flex justify-between text-xs mb-1">
                                <span className={`${darkMode ? 'text-gray-300' : 'text-gray-600'} font-medium`}>{item.name}</span>
                                <span className={`${darkMode ? 'text-white' : 'text-gray-900'} font-bold`}>₹{item.value.toLocaleString()}</span>
                            </div>
                            <div className={`w-full h-3 rounded-full ${darkMode ? 'bg-gray-700' : 'bg-gray-100'} overflow-hidden`}>
                                <div 
                                    style={{ width: `${(item.value / stats.total) * 100}%` }} 
                                    className={`h-full rounded-full ${colors[index % colors.length]}`}
                                ></div>
                            </div>
                            </div>
                        ))}
                        </div>
                    ) : (
                        <div className="h-48 flex items-center justify-center text-gray-400">No data available</div>
                    )}
                    </div>
                </div>
                </div>
            );
        };

        const SocialSection = ({ darkMode, socialLinks, socialCategories, onSave, onDelete }) => {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [form, setForm] = useState({ name: '', url: '', category: '' });
            const [editingId, setEditingId] = useState(null);
            const [filter, setFilter] = useState('All');

            useEffect(() => {
                if (!form.category && socialCategories.length > 0) {
                    setForm(prev => ({ ...prev, category: socialCategories[0].name }));
                }
            }, [socialCategories, isModalOpen]);

            const handleSubmit = (e) => {
                e.preventDefault();
                let url = form.url;
                if (url && !url.startsWith('http')) url = `https://${url}`;
                
                onSave({ 
                    id: editingId,
                    name: form.name, 
                    url,
                    category: form.category || (socialCategories[0] ? socialCategories[0].name : 'General')
                });

                setIsModalOpen(false);
                setForm({ name: '', url: '', category: '' });
                setEditingId(null);
            };

            const handleEdit = (link, e) => {
                e.stopPropagation();
                setForm({ name: link.name, url: link.url, category: link.category });
                setEditingId(link.id);
                setIsModalOpen(true);
            };

            const handleOpenModal = () => {
                setForm({ name: '', url: '', category: socialCategories[0] ? socialCategories[0].name : '' });
                setEditingId(null);
                setIsModalOpen(true);
            };

            const filteredLinks = filter === 'All' 
                ? socialLinks 
                : socialLinks.filter(link => link.category === filter);

            return (
                <div className="space-y-6">
                <div className="flex justify-between items-center">
                    <h2 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Social Media & Tools</h2>
                    <button 
                        onClick={handleOpenModal}
                        className="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 transition flex items-center gap-2"
                    >
                    <Plus size={16} /> <span className="hidden md:inline">Add New</span>
                    </button>
                </div>

                {/* Filter Bar */}
                <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide -mx-4 px-4 md:mx-0 md:px-0">
                    <button 
                        onClick={() => setFilter('All')}
                        className={`px-4 py-1.5 rounded-full text-sm font-medium whitespace-nowrap transition-colors border ${
                            filter === 'All' 
                            ? 'bg-indigo-600 text-white border-indigo-600' 
                            : `${darkMode ? 'bg-gray-800 border-gray-700 text-gray-300 hover:bg-gray-700' : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50'}`
                        }`}
                    >
                        All Items
                    </button>
                    {socialCategories.map(cat => (
                        <button 
                            key={cat.id}
                            onClick={() => setFilter(cat.name)}
                            className={`px-4 py-1.5 rounded-full text-sm font-medium whitespace-nowrap transition-colors border ${
                                filter === cat.name 
                                ? 'bg-indigo-600 text-white border-indigo-600' 
                                : `${darkMode ? 'bg-gray-800 border-gray-700 text-gray-300 hover:bg-gray-700' : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50'}`
                            }`}
                        >
                            {cat.name}
                        </button>
                    ))}
                </div>

                {isModalOpen && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                    <div className={`${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white'} rounded-xl shadow-2xl w-full max-w-md p-6 border`}>
                        <div className="flex justify-between items-center mb-6">
                        <h3 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                            {editingId ? 'Edit Item' : 'Add New Item'}
                        </h3>
                        <button onClick={() => setIsModalOpen(false)} className="text-gray-400 hover:text-gray-500"><X size={24} /></button>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-500 mb-1">Name</label>
                            <input 
                            autoFocus type="text" placeholder="e.g. Instagram, Canva, Buffer"
                            className={`w-full p-2 rounded-lg border ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-gray-50 border-gray-200'} focus:ring-2 focus:ring-indigo-500 focus:outline-none`}
                            value={form.name} onChange={e => setForm({...form, name: e.target.value})}
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-500 mb-1">Category</label>
                            <select 
                                className={`w-full p-2 rounded-lg border ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-gray-50 border-gray-200'} focus:ring-2 focus:ring-indigo-500 focus:outline-none`}
                                value={form.category} 
                                onChange={e => setForm({...form, category: e.target.value})}
                            >
                                {socialCategories.map(cat => (
                                    <option key={cat.id} value={cat.name}>{cat.name}</option>
                                ))}
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-500 mb-1">Link / URL</label>
                            <input 
                            type="text" placeholder="e.g. https://..."
                            className={`w-full p-2 rounded-lg border ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-gray-50 border-gray-200'} focus:ring-2 focus:ring-indigo-500 focus:outline-none`}
                            value={form.url} onChange={e => setForm({...form, url: e.target.value})}
                            />
                        </div>
                        <div className="pt-4 flex justify-end gap-3">
                            <button type="button" onClick={() => setIsModalOpen(false)} className="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">Cancel</button>
                            <button type="submit" className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium">Save</button>
                        </div>
                        </form>
                    </div>
                    </div>
                )}
                
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    {filteredLinks.length === 0 && (
                        <div className="col-span-full text-center py-12 text-gray-400">
                            No items found in this category.
                        </div>
                    )}
                    {filteredLinks.map((link) => (
                    <div 
                        key={link.id} 
                        onClick={() => window.open(link.url, '_blank')}
                        className={`${darkMode ? 'bg-gray-800 border-gray-700 hover:border-gray-500' : 'bg-white border-gray-100 hover:border-indigo-300'} p-6 rounded-xl border relative overflow-hidden cursor-pointer transition-all group hover:-translate-y-1 shadow-sm flex flex-col justify-between h-full`}
                    >
                        <div className="absolute top-2 right-2 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity z-10">
                        <button onClick={(e) => handleEdit(link, e)} className="p-1.5 bg-white/10 backdrop-blur-md rounded-full hover:bg-indigo-500 hover:text-white transition shadow-sm"><Edit2 size={14} /></button>
                        <button onClick={(e) => { e.stopPropagation(); onDelete(link.id); }} className="p-1.5 bg-white/10 backdrop-blur-md rounded-full hover:bg-red-500 hover:text-white transition shadow-sm"><Trash2 size={14} /></button>
                        </div>

                        <div>
                            <div className="flex justify-between items-start mb-4">
                                <div className={`p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                                    <Share2 size={24} className={darkMode ? 'text-indigo-400' : 'text-indigo-600'} />
                                </div>
                                <span className={`text-[10px] uppercase font-bold tracking-wide px-2 py-1 rounded ${darkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-100 text-gray-500'}`}>
                                    {link.category || 'General'}
                                </span>
                            </div>
                            <h3 className={`text-lg font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-1`}>{link.name}</h3>
                        </div>
                        
                        {link.url && (
                        <div className="mt-4 flex gap-2 items-center text-xs text-indigo-500 font-medium">
                            Visit Link <ExternalLink size={12} />
                        </div>
                        )}
                    </div>
                    ))}
                </div>
                </div>
            );
        };

        const AdSpendSection = ({ darkMode, platforms, adTypes, ads, onSave, onDelete }) => {
            const [form, setForm] = useState({ 
                id: null, type: '', platform: '', influencerName: '', 
                printMedium: '', customDetails: '', amount: '', date: '', remark: ''
            });
            const [isEditing, setIsEditing] = useState(false);
            
            useEffect(() => {
                if (!form.type && adTypes.length > 0) {
                    setForm(prev => ({ ...prev, type: adTypes[0].name }));
                }
            }, [adTypes]);

            const handleSubmit = (e) => {
                e.preventDefault();
                const entryData = { 
                    id: form.id, 
                    type: form.type,
                    amount: form.amount ? parseFloat(form.amount) : 0,
                    date: form.date,
                    remark: form.remark,
                    platform: form.type === 'Performance' ? form.platform : '',
                    influencerName: form.type === 'Influencer' ? form.influencerName : '',
                    printMedium: form.type === 'Print Media' ? form.printMedium : '',
                    customDetails: !['Performance', 'Influencer', 'Print Media'].includes(form.type) ? form.customDetails : ''
                };
                onSave(entryData);
                resetForm();
            };

            const resetForm = () => {
                setIsEditing(false);
                setForm({ 
                    id: null,
                    type: adTypes.length > 0 ? adTypes[0].name : '', 
                    platform: platforms.length > 0 ? platforms[0].name : '', 
                    influencerName: '', printMedium: '', customDetails: '', amount: '', date: '', remark: ''
                });
            };

            const handleEdit = (ad) => {
                setIsEditing(true);
                setForm({
                    id: ad.id,
                    type: ad.type,
                    platform: ad.platform || (platforms.length > 0 ? platforms[0].name : ''),
                    influencerName: ad.influencerName || '',
                    printMedium: ad.printMedium || '',
                    customDetails: ad.customDetails || '',
                    amount: ad.amount || '',
                    date: ad.date || '',
                    remark: ad.remark || ''
                });
            };

            const inputClass = `w-full p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 ${
                darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'bg-gray-50 border border-gray-200 text-gray-900'
            }`;

            return (
                <div className="space-y-6">
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div className={`${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-100'} p-6 rounded-xl shadow-sm border h-fit`}>
                    <h3 className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-4 flex items-center gap-2`}>
                        {isEditing ? <Edit2 size={18} className="text-orange-500" /> : <Plus size={18} className="text-indigo-600" />} 
                        {isEditing ? 'Edit Entry' : 'New Ad Entry'}
                    </h3>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Advertisement Type</label>
                        <select className={inputClass} value={form.type} onChange={e => setForm({...form, type: e.target.value})}>
                            {adTypes.map(type => <option key={type.id} value={type.name}>{type.name}</option>)}
                        </select>
                        </div>

                        {form.type === 'Performance' && (
                            <div>
                            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Platform</label>
                            <select className={inputClass} value={form.platform} onChange={e => setForm({...form, platform: e.target.value})}>
                                <option value="" disabled>Select Platform</option>
                                {platforms.map(p => <option key={p.id} value={p.name}>{p.name}</option>)}
                            </select>
                            </div>
                        )}

                        {form.type === 'Influencer' && (
                            <div>
                            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Influencer Name</label>
                            <input type="text" placeholder="e.g. @Sarah_LifeStyle" className={inputClass} value={form.influencerName} onChange={e => setForm({...form, influencerName: e.target.value})}/>
                            </div>
                        )}

                        {form.type === 'Print Media' && (
                            <div>
                            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Publication / Medium</label>
                            <input type="text" placeholder="e.g. NY Times" className={inputClass} value={form.printMedium} onChange={e => setForm({...form, printMedium: e.target.value})}/>
                            </div>
                        )}

                        {!['Performance', 'Influencer', 'Print Media'].includes(form.type) && (
                            <div>
                            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Details / Target</label>
                            <input type="text" placeholder="e.g. Channel Name" className={inputClass} value={form.customDetails} onChange={e => setForm({...form, customDetails: e.target.value})}/>
                            </div>
                        )}

                        <div>
                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Cost (₹)</label>
                        <input type="number" placeholder="0.00" className={inputClass} value={form.amount} onChange={e => setForm({...form, amount: e.target.value})}/>
                        </div>
                        <div>
                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Date</label>
                        <input type="date" className={inputClass} value={form.date} onChange={e => setForm({...form, date: e.target.value})}/>
                        </div>
                        <div>
                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Remark</label>
                        <textarea rows="2" placeholder="Optional notes..." className={inputClass} value={form.remark} onChange={e => setForm({...form, remark: e.target.value})}/>
                        </div>

                        <div className="flex gap-2">
                            <button type="submit" className={`flex-1 ${isEditing ? 'bg-orange-500 hover:bg-orange-600' : 'bg-indigo-600 hover:bg-indigo-700'} text-white py-2 rounded-lg font-bold transition`}>
                                {isEditing ? 'Update' : 'Save'}
                            </button>
                            {isEditing && (
                                <button type="button" onClick={resetForm} className="px-4 py-2 bg-gray-200 text-gray-600 rounded-lg font-bold hover:bg-gray-300 transition">Cancel</button>
                            )}
                        </div>
                    </form>
                    </div>

                    <div className={`lg:col-span-2 ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-100'} rounded-xl shadow-sm border overflow-hidden flex flex-col`}>
                        <div className={`p-6 border-b ${darkMode ? 'border-gray-700' : 'border-gray-100'} flex justify-between items-center`}>
                            <h3 className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Recent Spending</h3>
                            <span className={`text-xs ${darkMode ? 'bg-indigo-900 text-indigo-300' : 'bg-indigo-100 text-indigo-700'} px-2 py-1 rounded font-medium`}>
                                Total: ₹{ads.reduce((acc, curr) => acc + parseFloat(curr.amount || 0), 0).toFixed(2)}
                            </span>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-left">
                                <thead className={`${darkMode ? 'bg-gray-900 text-gray-400' : 'bg-gray-50 text-gray-500'} text-xs uppercase`}>
                                    <tr>
                                        <th className="p-4">Type / Details</th>
                                        <th className="p-4">Date</th>
                                        <th className="p-4">Amount</th>
                                        <th className="p-4">Action</th>
                                    </tr>
                                </thead>
                                <tbody className={`divide-y ${darkMode ? 'divide-gray-700' : 'divide-gray-100'}`}>
                                    {ads.length === 0 ? (
                                        <tr><td colSpan="4" className="p-8 text-center text-gray-400">No entries yet. Add one!</td></tr>
                                    ) : (
                                        ads.map(ad => (
                                            <tr key={ad.id} className={`${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-50'} transition group`}>
                                                <td className="p-4">
                                                    <div className="flex flex-col items-start gap-1">
                                                        <span className={`text-[10px] uppercase font-bold tracking-wide ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>{ad.type}</span>
                                                        <span className={`text-xs font-medium px-2 py-1 rounded ${darkMode ? 'bg-gray-700 text-gray-300 border-gray-600' : 'bg-gray-100 text-gray-600 border-gray-200'} border whitespace-nowrap`}>
                                                            {ad.type === 'Influencer' ? ad.influencerName : 
                                                            ad.type === 'Print Media' ? ad.printMedium : 
                                                            ad.type === 'Performance' ? ad.platform : 
                                                            ad.customDetails || 'General'}
                                                        </span>
                                                        {ad.remark && <span className="text-xs text-gray-400 italic truncate max-w-[200px]">{ad.remark}</span>}
                                                    </div>
                                                </td>
                                                <td className="p-4 text-gray-500 text-sm whitespace-nowrap">{ad.date || '-'}</td>
                                                <td className={`p-4 font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>₹{parseFloat(ad.amount || 0).toFixed(2)}</td>
                                                <td className="p-4">
                                                    <div className="flex items-center gap-2">
                                                        <button onClick={() => handleEdit(ad)} className="text-indigo-400 hover:text-indigo-600 transition"><Edit2 size={16} /></button>
                                                        <button onClick={() => onDelete(ad.id)} className="text-red-400 hover:text-red-600 transition"><Trash2 size={16} /></button>
                                                    </div>
                                                </td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                </div>
            );
        };

        const EcommerceSection = ({ darkMode, links, onSave, onDelete }) => {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingLink, setEditingLink] = useState(null);
            const [form, setForm] = useState({ title: '', url: '' });

            const handleOpenModal = (link = null) => {
                setEditingLink(link);
                setForm(link ? { title: link.title, url: link.url } : { title: '', url: '' });
                setIsModalOpen(true);
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                let url = form.url;
                if (url && !url.startsWith('http')) url = `https://${url}`;
                
                const colors = ['bg-purple-600', 'bg-pink-600', 'bg-cyan-600', 'bg-indigo-600'];
                const color = editingLink ? editingLink.color : colors[Math.floor(Math.random() * colors.length)];

                onSave({
                    id: editingLink ? editingLink.id : null,
                    title: form.title,
                    url,
                    color
                });
                setIsModalOpen(false);
            };

            const handleDelete = (id, e) => {
                e.stopPropagation();
                onDelete(id);
            };

            return (
                <div className="space-y-6 relative">
                {isModalOpen && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                    <div className={`${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white'} rounded-xl shadow-2xl w-full max-w-md p-6 border`}>
                        <div className="flex justify-between items-center mb-6">
                        <h3 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                            {editingLink ? 'Edit Shortcut' : 'Add New Shortcut'}
                        </h3>
                        <button onClick={() => setIsModalOpen(false)} className="text-gray-400 hover:text-gray-500"><X size={24} /></button>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-500 mb-1">Title</label>
                            <input 
                            autoFocus type="text" placeholder="e.g. Amazon Store"
                            className={`w-full p-2 rounded-lg border ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-gray-50 border-gray-200'} focus:ring-2 focus:ring-indigo-500 focus:outline-none`}
                            value={form.title} onChange={e => setForm({...form, title: e.target.value})}
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-500 mb-1">URL / Link</label>
                            <input 
                            type="text" placeholder="e.g. www.amazon.com"
                            className={`w-full p-2 rounded-lg border ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-gray-50 border-gray-200'} focus:ring-2 focus:ring-indigo-500 focus:outline-none`}
                            value={form.url} onChange={e => setForm({...form, url: e.target.value})}
                            />
                        </div>
                        <div className="pt-4 flex justify-end gap-3">
                            <button type="button" onClick={() => setIsModalOpen(false)} className="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">Cancel</button>
                            <button type="submit" className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium">Save Shortcut</button>
                        </div>
                        </form>
                    </div>
                    </div>
                )}

                <div className={`${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-100'} rounded-xl shadow-sm border overflow-hidden p-6`}>
                    <h3 className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-4`}>Quick Access & Platforms</h3>
                    <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                    {links.map(link => (
                        <div 
                        key={link.id} 
                        onClick={() => window.open(link.url, '_blank')}
                        className={`relative group cursor-pointer rounded-xl border-2 ${darkMode ? 'bg-gray-700 border-gray-600 hover:border-gray-500' : 'bg-gray-50 border-gray-100 hover:border-indigo-100'} p-4 flex flex-col items-center text-center transition-all hover:-translate-y-1`}
                        >
                        <div className="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button 
                            onClick={(e) => { e.stopPropagation(); handleOpenModal(link); }}
                            className="p-1.5 bg-white text-gray-600 rounded-full shadow hover:text-indigo-600" title="Edit"
                            >
                            <Edit2 size={12} />
                            </button>
                            <button 
                            onClick={(e) => { e.stopPropagation(); handleDelete(link.id, e); }}
                            className="p-1.5 bg-white text-gray-600 rounded-full shadow hover:text-red-500" title="Delete"
                            >
                            <Trash2 size={12} />
                            </button>
                        </div>

                        <div className={`w-12 h-12 rounded-full ${link.color} flex items-center justify-center text-white mb-3 shadow-md`}>
                            <Globe size={20} />
                        </div>
                        <p className={`font-bold text-sm ${darkMode ? 'text-gray-200' : 'text-gray-700'} line-clamp-1`}>{link.title}</p>
                        <p className="text-xs text-gray-400 flex items-center gap-1 mt-1">
                            Visit <ExternalLink size={10} />
                        </p>
                        </div>
                    ))}

                    <button 
                        onClick={() => handleOpenModal()}
                        className={`rounded-xl border-2 border-dashed ${darkMode ? 'border-gray-600 hover:border-gray-500 hover:bg-gray-700' : 'border-gray-200 hover:border-indigo-300 hover:bg-indigo-50'} p-4 flex flex-col items-center justify-center text-center transition-all min-h-[140px]`}
                    >
                        <div className={`w-10 h-10 rounded-full ${darkMode ? 'bg-gray-700 text-gray-400' : 'bg-gray-100 text-gray-400'} flex items-center justify-center mb-2`}>
                        <Plus size={24} />
                        </div>
                        <span className={`text-sm font-medium ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Add Shortcut</span>
                    </button>
                    </div>
                </div>
                </div>
            );
        };

        const SettingsSection = ({ 
            darkMode, setDarkMode, 
            platforms, onAddPlatform, onEditPlatform, onDeletePlatform,
            adTypes, onAddAdType, onEditAdType, onDeleteAdType,
            socialCategories, onAddSocialCategory, onEditSocialCategory, onDeleteSocialCategory,
            ads, onLogout, accessCode 
        }) => {
            const [newItem, setNewItem] = useState('');
            const [editItem, setEditItem] = useState({ id: null, value: '' });
            const [activeTab, setActiveTab] = useState('platforms');

            const handleAddItem = (e) => {
                e.preventDefault();
                if (newItem.trim()) {
                    if(activeTab === 'platforms') onAddPlatform(newItem.trim());
                    else if(activeTab === 'adTypes') onAddAdType(newItem.trim());
                    else if(activeTab === 'socialCats') onAddSocialCategory(newItem.trim());
                    setNewItem('');
                }
            };

            const handleDelete = (id) => {
                if(activeTab === 'platforms') onDeletePlatform(id);
                else if(activeTab === 'adTypes') onDeleteAdType(id);
                else if(activeTab === 'socialCats') onDeleteSocialCategory(id);
            };

            const startEdit = (id, value) => setEditItem({ id, value });

            const saveEdit = () => {
                if (editItem.value.trim() && editItem.id !== null) {
                    if(activeTab === 'platforms') onEditPlatform(editItem.id, editItem.value.trim());
                    else if(activeTab === 'adTypes') onEditAdType(editItem.id, editItem.value.trim());
                    else if(activeTab === 'socialCats') onEditSocialCategory(editItem.id, editItem.value.trim());
                    setEditItem({ id: null, value: '' });
                }
            };

            const handleExport = () => {
                const headers = ["ID", "Type", "Platform/Source", "Cost", "Date", "Remark"];
                const rows = ads.map(ad => [
                    ad.id,
                    ad.type,
                    ad.type === 'Influencer' ? ad.influencerName : ad.type === 'Print Media' ? ad.printMedium : ad.type === 'Performance' ? ad.platform : ad.customDetails,
                    ad.amount,
                    ad.date,
                    `"${ad.remark || ''}"`
                ]);

                const csvContent = "data:text/csv;charset=utf-8," 
                    + headers.join(",") + "\n" 
                    + rows.map(e => e.join(",")).join("\n");

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "guru_ad_data.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const getCurrentList = () => {
                if(activeTab === 'platforms') return platforms;
                if(activeTab === 'adTypes') return adTypes;
                if(activeTab === 'socialCats') return socialCategories;
                return [];
            };

            const currentList = getCurrentList();

            return (
                <div className="space-y-6">
                    <div className={`max-w-2xl ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-100'} rounded-xl shadow-sm border overflow-hidden`}>
                        <div className={`p-6 border-b ${darkMode ? 'border-gray-700' : 'border-gray-100'}`}>
                            <h2 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Platform Settings</h2>
                            <p className="text-sm text-gray-500 mt-1">Dashboard Code: <span className="font-mono bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded text-xs">{accessCode}</span></p>
                        </div>
                        <div className="p-6 space-y-6">
                            <div className={`space-y-4 pb-6 border-b ${darkMode ? 'border-gray-700' : 'border-gray-100'}`}>
                                <div className="flex items-center justify-between">
                                    <div>
                                        <h4 className={`font-medium ${darkMode ? 'text-white' : 'text-gray-800'}`}>Theme Preference</h4>
                                        <p className="text-sm text-gray-500">Toggle light/dark mode.</p>
                                    </div>
                                    <button onClick={() => setDarkMode(!darkMode)} className={`w-12 h-6 rounded-full relative transition-colors ${darkMode ? 'bg-indigo-600' : 'bg-gray-200'}`}>
                                        <div className={`absolute top-1 w-4 h-4 bg-white rounded-full shadow-sm transition-all ${darkMode ? 'left-7' : 'left-1'}`}></div>
                                    </button>
                                </div>
                                <div className="flex items-center justify-between">
                                    <div>
                                        <h4 className={`font-medium ${darkMode ? 'text-white' : 'text-gray-800'}`}>Export Data</h4>
                                        <p className="text-sm text-gray-500">Download ad spend history as CSV.</p>
                                    </div>
                                    <button onClick={handleExport} className="flex items-center gap-2 bg-green-600 text-white px-4 py-1.5 rounded-lg text-sm font-medium hover:bg-green-700 transition">
                                        <Download size={16} /> Download CSV
                                    </button>
                                </div>
                                 <div className="flex items-center justify-between">
                                    <div>
                                        <h4 className={`font-medium ${darkMode ? 'text-white' : 'text-gray-800'}`}>Sign Out</h4>
                                        <p className="text-sm text-gray-500">Exit this dashboard code.</p>
                                    </div>
                                    <button onClick={onLogout} className="flex items-center gap-2 bg-red-600 text-white px-4 py-1.5 rounded-lg text-sm font-medium hover:bg-red-700 transition">
                                        <LogOut size={16} /> Sign Out
                                    </button>
                                </div>
                            </div>

                            <div>
                                <div className="flex gap-2 overflow-x-auto pb-2 border-b border-gray-200 mb-4 scrollbar-hide">
                                    <button onClick={() => setActiveTab('platforms')} className={`px-3 py-1 text-sm font-medium whitespace-nowrap transition-colors rounded-lg ${activeTab === 'platforms' ? 'bg-indigo-50 text-indigo-600' : 'text-gray-500 hover:text-gray-700'}`}>Ad Platforms</button>
                                    <button onClick={() => setActiveTab('adTypes')} className={`px-3 py-1 text-sm font-medium whitespace-nowrap transition-colors rounded-lg ${activeTab === 'adTypes' ? 'bg-indigo-50 text-indigo-600' : 'text-gray-500 hover:text-gray-700'}`}>Ad Types</button>
                                    <button onClick={() => setActiveTab('socialCats')} className={`px-3 py-1 text-sm font-medium whitespace-nowrap transition-colors rounded-lg ${activeTab === 'socialCats' ? 'bg-indigo-50 text-indigo-600' : 'text-gray-500 hover:text-gray-700'}`}>Social Categories</button>
                                </div>
                                
                                <div className="flex gap-2 mb-4">
                                    <input type="text" placeholder={`Add new...`} className={`flex-1 p-2 rounded-lg border ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-gray-50 border-gray-200'} focus:ring-2 focus:ring-indigo-500 focus:outline-none`} value={newItem} onChange={e => setNewItem(e.target.value)} />
                                    <button onClick={handleAddItem} className="bg-indigo-600 text-white px-4 rounded-lg font-medium hover:bg-indigo-700">Add</button>
                                </div>

                                <div className="space-y-2 max-h-60 overflow-y-auto">
                                    {currentList.map((item) => (
                                        <div key={item.id} className={`flex items-center justify-between p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-50'} border ${darkMode ? 'border-gray-600' : 'border-gray-100'}`}>
                                            {editItem.id === item.id ? (
                                                <div className="flex gap-2 flex-1 mr-2">
                                                    <input className={`flex-1 p-1 rounded ${darkMode ? 'bg-gray-800 text-white' : 'bg-white'}`} value={editItem.value} onChange={e => setEditItem({...editItem, value: e.target.value})} />
                                                    <button onClick={saveEdit} className="text-green-500 hover:text-green-600"><Save size={16} /></button>
                                                </div>
                                            ) : (
                                                <span className={`text-sm ${darkMode ? 'text-gray-200' : 'text-gray-700'}`}>{item.name}</span>
                                            )}
                                            <div className="flex gap-2">
                                                {editItem.id !== item.id && <button onClick={() => startEdit(item.id, item.name)} className="text-gray-400 hover:text-indigo-500"><Edit2 size={16} /></button>}
                                                <button onClick={() => handleDelete(item.id)} className="text-gray-400 hover:text-red-500"><Trash2 size={16} /></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---

        function GuruMarketingApp() {
            const [accessCode, setAccessCode] = useState(localStorage.getItem('guru_access_code'));
            const [activeTab, setActiveTab] = useState('analysis');
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            const [isMobileOpen, setIsMobileOpen] = useState(false); // Mobile Menu State
            const [user, setUser] = useState(null);
            
            // Data States
            const [ads, setAds] = useState([]);
            const [platforms, setPlatforms] = useState([]);
            const [adTypes, setAdTypes] = useState([]);
            const [socialLinks, setSocialLinks] = useState([]);
            const [socialCategories, setSocialCategories] = useState([]);
            const [links, setLinks] = useState([]);
            const [darkMode, setDarkMode] = useState(localStorage.getItem('guru_theme') === 'true');

            // Handle Theme
            useEffect(() => {
                if (darkMode) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
                localStorage.setItem('guru_theme', darkMode);
            }, [darkMode]);

            // Auth
            useEffect(() => {
                const initAuth = async () => {
                    try { await signInAnonymously(auth); } catch (e) { console.error("Auth failed:", e); }
                };
                initAuth();
                return onAuthStateChanged(auth, setUser);
            }, []);

            // Login Handler
            const handleJoin = (code) => {
                localStorage.setItem('guru_access_code', code);
                setAccessCode(code);
            };

            const handleLogout = () => {
                localStorage.removeItem('guru_access_code');
                setAccessCode(null);
                setAds([]); setPlatforms([]); setAdTypes([]);
            };

            // Data Sync
            useEffect(() => {
                if (!user || !accessCode) return;

                const getPath = (col) => collection(db, 'artifacts', APP_ID, 'teams', accessCode, col);

                const unsubAds = onSnapshot(query(getPath('ads'), orderBy('date', 'desc')), (snapshot) => {
                    setAds(snapshot.docs.map(d => ({ id: d.id, ...d.data() })));
                });

                const unsubPlatforms = onSnapshot(getPath('platforms'), async (snapshot) => {
                    if (snapshot.empty) {
                        ['Facebook Ads', 'Google Search', 'Instagram Boost', 'TikTok Ads', 'LinkedIn Ads', 'YouTube Ads'].forEach(name => addDoc(getPath('platforms'), { name }));
                    } else {
                        setPlatforms(snapshot.docs.map(d => ({ id: d.id, ...d.data() })));
                    }
                });

                const unsubTypes = onSnapshot(getPath('ad_types'), async (snapshot) => {
                    if (snapshot.empty) {
                        ['Performance', 'Influencer', 'Print Media'].forEach(name => addDoc(getPath('ad_types'), { name }));
                    } else {
                        setAdTypes(snapshot.docs.map(d => ({ id: d.id, ...d.data() })));
                    }
                });

                const unsubSocial = onSnapshot(getPath('social_links'), (snapshot) => {
                    setSocialLinks(snapshot.docs.map(d => ({ id: d.id, ...d.data() })));
                });

                const unsubSocialCats = onSnapshot(getPath('social_categories'), async (snapshot) => {
                    if (snapshot.empty) {
                        ['Social Profile', 'Ad Tool', 'Content Platform', 'Other'].forEach(name => addDoc(getPath('social_categories'), { name }));
                    } else {
                        setSocialCategories(snapshot.docs.map(d => ({ id: d.id, ...d.data() })));
                    }
                });

                const unsubLinks = onSnapshot(getPath('ecommerce_links'), (snapshot) => {
                    if (snapshot.empty) {
                        addDoc(getPath('ecommerce_links'), { title: 'Amazon Store', url: 'https://www.amazon.com', color: 'bg-orange-500' });
                    } else {
                        setLinks(snapshot.docs.map(d => ({ id: d.id, ...d.data() })));
                    }
                });

                return () => { unsubAds(); unsubPlatforms(); unsubTypes(); unsubSocial(); unsubSocialCats(); unsubLinks(); };
            }, [user, accessCode]);

            const getPath = (col) => collection(db, 'artifacts', APP_ID, 'teams', accessCode, col);

            const handleSaveItem = async (colName, item) => {
                if (!user || !accessCode) return;
                const { id, ...data } = item;
                if (id) await updateDoc(doc(db, 'artifacts', APP_ID, 'teams', accessCode, colName, id), data);
                else await addDoc(getPath(colName), data);
            };

            const handleDeleteItem = async (colName, id) => {
                if (!user || !accessCode) return;
                await deleteDoc(doc(db, 'artifacts', APP_ID, 'teams', accessCode, colName, id));
            };

            // Handlers
            const onSaveAd = (ad) => handleSaveItem('ads', ad);
            const onDeleteAd = (id) => handleDeleteItem('ads', id);
            const onSaveSocial = (link) => handleSaveItem('social_links', link);
            const onDeleteSocial = (id) => handleDeleteItem('social_links', id);
            const onSaveLink = (link) => handleSaveItem('ecommerce_links', link);
            const onDeleteLink = (id) => handleDeleteItem('ecommerce_links', id);
            const onAddPlatform = (name) => addDoc(getPath('platforms'), { name });
            const onEditPlatform = (id, name) => updateDoc(doc(db, 'artifacts', APP_ID, 'teams', accessCode, 'platforms', id), { name });
            const onDeletePlatform = (id) => handleDeleteItem('platforms', id);
            const onAddAdType = (name) => addDoc(getPath('ad_types'), { name });
            const onEditAdType = (id, name) => updateDoc(doc(db, 'artifacts', APP_ID, 'teams', accessCode, 'ad_types', id), { name });
            const onDeleteAdType = (id) => handleDeleteItem('ad_types', id);
            const onAddSocialCategory = (name) => addDoc(getPath('social_categories'), { name });
            const onEditSocialCategory = (id, name) => updateDoc(doc(db, 'artifacts', APP_ID, 'teams', accessCode, 'social_categories', id), { name });
            const onDeleteSocialCategory = (id) => handleDeleteItem('social_categories', id);

            // Handle Tab Switching to close mobile menu
            const switchTab = (tab) => {
                setActiveTab(tab);
                setIsMobileOpen(false);
            };

            if (!accessCode) {
                return <LoginScreen onJoin={handleJoin} darkMode={darkMode} />;
            }

            const renderContent = () => {
                switch (activeTab) {
                    case 'analysis': return <AnalysisSection ads={ads} darkMode={darkMode} />;
                    case 'social': return <SocialSection darkMode={darkMode} socialLinks={socialLinks} socialCategories={socialCategories} onSave={onSaveSocial} onDelete={onDeleteSocial} />;
                    case 'adspend': return <AdSpendSection darkMode={darkMode} platforms={platforms} adTypes={adTypes} ads={ads} onSave={onSaveAd} onDelete={onDeleteAd} />;
                    case 'ecommerce': return <EcommerceSection darkMode={darkMode} links={links} onSave={onSaveLink} onDelete={onDeleteLink} />;
                    case 'settings': return <SettingsSection darkMode={darkMode} setDarkMode={setDarkMode} 
                        platforms={platforms} onAddPlatform={onAddPlatform} onEditPlatform={onEditPlatform} onDeletePlatform={onDeletePlatform} 
                        adTypes={adTypes} onAddAdType={onAddAdType} onEditAdType={onEditAdType} onDeleteAdType={onDeleteAdType} 
                        socialCategories={socialCategories} onAddSocialCategory={onAddSocialCategory} onEditSocialCategory={onEditSocialCategory} onDeleteSocialCategory={onDeleteSocialCategory}
                        ads={ads} onLogout={handleLogout} accessCode={accessCode} />;
                    default: return <AnalysisSection ads={ads} darkMode={darkMode} />;
                }
            };

            return (
                <div className={`flex h-screen font-sans transition-colors duration-200 ${darkMode ? 'bg-gray-900 text-gray-100' : 'bg-gray-50 text-gray-900'} overflow-hidden`}>
                    
                    {/* Mobile Overlay */}
                    {isMobileOpen && (
                        <div 
                            className="fixed inset-0 z-30 bg-black/50 backdrop-blur-sm md:hidden"
                            onClick={() => setIsMobileOpen(false)}
                        ></div>
                    )}

                    {/* Sidebar */}
                    <aside 
                        className={`
                            fixed inset-y-0 left-0 z-40 bg-gray-900 text-white transition-transform duration-300 transform flex flex-col
                            ${isMobileOpen ? 'translate-x-0' : '-translate-x-full'}
                            md:relative md:translate-x-0 
                            ${isSidebarOpen ? 'md:w-64' : 'md:w-20'}
                            w-64
                        `}
                    >
                        <div className="p-6 flex items-center gap-3">
                            <div className="w-8 h-8 bg-indigo-500 rounded-lg flex items-center justify-center flex-shrink-0"><span className="font-bold text-white">G</span></div>
                            <span className={`font-bold text-lg tracking-wide ${!isSidebarOpen && 'md:hidden'}`}>GURU<span className="text-indigo-400"> AD</span></span>
                        </div>
                        <nav className="flex-1 px-4 space-y-2 mt-4 overflow-y-auto">
                            <SidebarItem icon={TrendingUp} label={isSidebarOpen ? "Analysis & Stats" : ""} active={activeTab === 'analysis'} onClick={() => switchTab('analysis')} />
                            <SidebarItem icon={Share2} label={isSidebarOpen ? "Social Media" : ""} active={activeTab === 'social'} onClick={() => switchTab('social')} />
                            <SidebarItem icon={DollarSign} label={isSidebarOpen ? "Ad Spend Entry" : ""} active={activeTab === 'adspend'} onClick={() => switchTab('adspend')} />
                            <SidebarItem icon={ShoppingBag} label={isSidebarOpen ? "E-commerce" : ""} active={activeTab === 'ecommerce'} onClick={() => switchTab('ecommerce')} />
                            <div className={`pt-8 pb-2 ${!isSidebarOpen && 'md:hidden'}`}><p className="px-4 text-xs font-bold text-gray-500 uppercase">System</p></div>
                            <SidebarItem icon={Settings} label={isSidebarOpen ? "Settings" : ""} active={activeTab === 'settings'} onClick={() => switchTab('settings')} />
                        </nav>
                        <div className="p-4 border-t border-gray-800">
                            <a href="https://govindkapersonalsoftware.netlify.app/" target="_blank" rel="noopener noreferrer" className="flex items-center gap-3 hover:bg-gray-800 p-2 rounded-lg transition-colors group">
                                <div className="w-10 h-10 rounded-full bg-indigo-500 flex items-center justify-center text-sm font-bold flex-shrink-0">GP</div>
                                <div className={`overflow-hidden ${!isSidebarOpen && 'md:hidden'}`}><p className="text-sm font-medium truncate group-hover:text-white transition-colors">GovindP1406</p></div>
                            </a>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 flex flex-col h-screen overflow-hidden relative">
                        <header className={`h-16 ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} border-b flex items-center justify-between px-4 md:px-6 flex-shrink-0 transition-colors`}>
                            <div className="flex items-center gap-4">
                                <button 
                                    onClick={() => {
                                        if (window.innerWidth < 768) setIsMobileOpen(!isMobileOpen);
                                        else setIsSidebarOpen(!isSidebarOpen);
                                    }} 
                                    className={`p-2 rounded-lg ${darkMode ? 'hover:bg-gray-700 text-gray-400' : 'hover:bg-gray-100 text-gray-500'}`}
                                >
                                    <Menu size={20} />
                                </button>
                                <h1 className={`font-bold text-lg md:text-xl ${darkMode ? 'text-white' : 'text-gray-800'} capitalize truncate`}>
                                    {activeTab === 'adspend' ? 'Ad Spend' : activeTab}
                                </h1>
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="relative hidden md:block">
                                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={16} />
                                    <input type="text" placeholder="Search..." className={`pl-10 pr-4 py-2 ${darkMode ? 'bg-gray-700 text-white focus:ring-indigo-400' : 'bg-gray-100 text-gray-900 focus:ring-indigo-500'} rounded-lg text-sm focus:outline-none focus:ring-2 w-64 transition-colors`} />
                                </div>
                                <button className={`relative p-2 rounded-lg ${darkMode ? 'hover:bg-gray-700 text-gray-400' : 'hover:bg-gray-100 text-gray-500'}`}>
                                    <Bell size={20} /><span className="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full border border-white"></span>
                                </button>
                            </div>
                        </header>
                        <div className={`flex-1 overflow-y-auto p-4 md:p-6 transition-colors ${darkMode ? 'bg-gray-900' : 'bg-gray-50'}`}>
                            <div className="max-w-7xl mx-auto">{renderContent()}</div>
                        </div>
                    </main>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<GuruMarketingApp />);
    </script>
</body>
</html>
